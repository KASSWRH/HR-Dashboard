{% extends "layout.html" %}

{% block content %}
<div class="attendance-container">
    <div class="attendance-header">
        <div class="stats-row">
            <div class="stat-card">
                <div class="stat-icon"><i class="fas fa-users"></i></div>
                <div class="stat-content">
                    <h3>{{ departments.values()|sum }}</h3>
                    <p>Total Employees</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon"><i class="fas fa-user-check"></i></div>
                <div class="stat-content">
                    <h3>{{ (departments.values()|sum * 0.95)|round|int }}</h3>
                    <p>Present Today</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon"><i class="fas fa-user-times"></i></div>
                <div class="stat-content">
                    <h3>{{ (departments.values()|sum * 0.05)|round|int }}</h3>
                    <p>Absent Today</p>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon"><i class="fas fa-chart-line"></i></div>
                <div class="stat-content">
                    <h3>96.8%</h3>
                    <p>Avg. Attendance Rate</p>
                </div>
            </div>
        </div>
    </div>
    
    <div class="attendance-body">
        <div class="card-row">
            <div class="card attendance-calendar">
                <div class="card-header">
                    <h3>Monthly Attendance Overview</h3>
                    <div class="month-selector">
                        <button class="month-nav"><i class="fas fa-chevron-left"></i></button>
                        <span id="current-month">April 2023</span>
                        <button class="month-nav"><i class="fas fa-chevron-right"></i></button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="calendar-wrapper">
                        <div class="calendar-header">
                            <div>Sun</div>
                            <div>Mon</div>
                            <div>Tue</div>
                            <div>Wed</div>
                            <div>Thu</div>
                            <div>Fri</div>
                            <div>Sat</div>
                        </div>
                        <div class="calendar-body" id="calendar-grid">
                            <!-- Calendar days will be generated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="card attendance-trend">
                <div class="card-header">
                    <h3>Attendance Trend</h3>
                </div>
                <div class="card-body">
                    <canvas id="attendanceTrendChart"></canvas>
                </div>
            </div>
        </div>
        
        <div class="card attendance-records">
            <div class="card-header">
                <h3>Attendance Records</h3>
                <div class="search-filter">
                    <input type="text" placeholder="Search employees..." id="attendanceSearch">
                    <select id="attendanceDepartmentFilter">
                        <option value="all">All Departments</option>
                        {% for dept in departments %}
                        <option value="{{ dept }}">{{ dept }}</option>
                        {% endfor %}
                    </select>
                    <input type="date" id="attendanceDateFilter" value="2023-04-24">
                </div>
            </div>
            <div class="card-body">
                <table class="attendance-table">
                    <thead>
                        <tr>
                            <th>Employee</th>
                            <th>Department</th>
                            <th>Check In</th>
                            <th>Check Out</th>
                            <th>Work Hours</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="attendanceTableBody">
                        {% for employee in employees %}
                        <tr data-department="{{ employee.department }}">
                            <td>
                                <div class="employee-info">
                                    <img style= "width: 200px;" src="https://images.unsplash.com/photo-1590650046871-92c887180603" alt="Employee">
                                    <div>
                                        <h4>{{ employee.name }}</h4>
                                        <p>{{ employee.position }}</p>
                                    </div>
                                </div>
                            </td>
                            <td>{{ employee.department }}</td>
                            <td>08:{{ 30 + loop.index0 * 5 }} AM</td>
                            <td>{% if loop.index0 % 4 != 3 %}05:{{ 30 + loop.index0 * 7 }} PM{% else %}-{% endif %}</td>
                            <td>{% if loop.index0 % 4 != 3 %}8h {{ loop.index0 * 10 }}m{% else %}-{% endif %}</td>
                            <td>
                                {% if loop.index0 % 4 == 0 %}
                                <span class="status-badge present">Present</span>
                                {% elif loop.index0 % 4 == 1 %}
                                <span class="status-badge late">Late</span>
                                {% elif loop.index0 % 4 == 2 %}
                                <span class="status-badge early-leave">Early Leave</span>
                                {% else %}
                                <span class="status-badge absent">Absent</span>
                                {% endif %}
                            </td>
                            <td>
                                <button class="action-btn view-btn"><i class="fas fa-eye"></i></button>
                                <button class="action-btn edit-btn"><i class="fas fa-edit"></i></button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        
        <div class="card-row">
            <div class="card leave-summary">
                <div class="card-header">
                    <h3>Leave Summary</h3>
                </div>
                <div class="card-body">
                    <canvas id="leaveSummaryChart"></canvas>
                </div>
            </div>
            
            <div class="card overtime-analysis">
                <div class="card-header">
                    <h3>Overtime Analysis</h3>
                </div>
                <div class="card-body">
                    <canvas id="overtimeChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        // Initialize attendance trend chart
        initializeAttendanceTrendChart();
        
        // Initialize leave summary chart
        initializeLeaveSummaryChart();
        
        // Initialize overtime chart
        initializeOvertimeChart();
        
        // Generate calendar
        generateCalendar();
        
        // Attendance search functionality
        const searchInput = document.getElementById('attendanceSearch');
        const departmentFilter = document.getElementById('attendanceDepartmentFilter');
        const dateFilter = document.getElementById('attendanceDateFilter');
        const attendanceRows = document.querySelectorAll('#attendanceTableBody tr');
        
        searchInput.addEventListener('input', filterAttendance);
        departmentFilter.addEventListener('change', filterAttendance);
        dateFilter.addEventListener('change', filterAttendance);
        
        function filterAttendance() {
            const searchTerm = searchInput.value.toLowerCase();
            const departmentValue = departmentFilter.value;
            
            attendanceRows.forEach(row => {
                const name = row.querySelector('.employee-info h4').textContent.toLowerCase();
                const department = row.getAttribute('data-department');
                
                const matchesSearch = name.includes(searchTerm);
                const matchesDepartment = departmentValue === 'all' || department === departmentValue;
                
                if (matchesSearch && matchesDepartment) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }
        
        function generateCalendar() {
            const calendarGrid = document.getElementById('calendar-grid');
            const daysInMonth = 30; // April
            const startDay = 6; // Saturday (April 1, 2023)
            
            // Clear previous calendar
            calendarGrid.innerHTML = '';
            
            // Add empty cells for days before the 1st of the month
            for (let i = 0; i < startDay; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.classList.add('calendar-day', 'empty');
                calendarGrid.appendChild(emptyDay);
            }
            
            // Add days of the month
            for (let day = 1; day <= daysInMonth; day++) {
                const dayCell = document.createElement('div');
                dayCell.classList.add('calendar-day');
                
                const dayNumber = document.createElement('div');
                dayNumber.classList.add('day-number');
                dayNumber.textContent = day;
                
                const attendanceStatus = document.createElement('div');
                attendanceStatus.classList.add('day-status');
                
                // Randomly assign attendance statuses
                const random = Math.random();
                if (day % 7 === 0 || day % 7 === 6) {
                    // Weekend
                    attendanceStatus.classList.add('weekend');
                    attendanceStatus.innerHTML = '<i class="fas fa-home"></i>';
                } else if (random > 0.92) {
                    // Absent
                    attendanceStatus.classList.add('absent');
                    attendanceStatus.innerHTML = '<i class="fas fa-times"></i>';
                } else if (random > 0.85) {
                    // Late
                    attendanceStatus.classList.add('late');
                    attendanceStatus.innerHTML = '<i class="fas fa-clock"></i>';
                } else {
                    // Present
                    attendanceStatus.classList.add('present');
                    attendanceStatus.innerHTML = '<i class="fas fa-check"></i>';
                }
                
                dayCell.appendChild(dayNumber);
                dayCell.appendChild(attendanceStatus);
                calendarGrid.appendChild(dayCell);
            }
        }
    });
</script>
{% endblock %}
